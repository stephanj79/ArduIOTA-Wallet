<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <title>ArduIOTA Wallet</title>
    <link rel="shortcut icon" href="favicon.ico">

    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
        crossorigin="anonymous">
    <link href="https://mybcard.de/style.css" rel="stylesheet">
    <link href="https://mybcard.de/send.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>

    <script type="text/javascript" src="https://mybcard.de/iota.min.js"></script>
    <script type="text/javascript" src="https://mybcard.de/curl.min.js"></script>
    <script>
        //var iota = new IOTA({ 'host': 'https://testnet.tangle.works', 'port': 443 }); TESTNET
        var host = (localStorage.getItem('host') != null ? localStorage.getItem('host') : 'https://n1.iota.nu')
        var port = (localStorage.getItem('port') != null ? localStorage.getItem('port') : 443)
        var iota = new IOTA({ 'host': host, 'port': port });
        var seed = ""; // <<<-------
        var balance = 0;
        var address;
        var einheit = 'Gi';
        var einheitOld = 'i';
        var txtModal = "";
        var addresses;
        var IsSending = false;

        curl.overrideAttachToTangle(iota.api);

        $(document).ready(ready);

        function ready() {
            $("#select_einheit").change(function (e) {
                einheitOld = einheit;
                einheit = $(this).val();
                updateBalanceHTML(balance);
                $("#select_einheit_senden").val(einheit);
            });
            $("#select_einheit_senden").change(function (e) {
                einheitOld = einheit;
                einheit = $(this).val();
                updateBalanceHTML(balance);
                $("#select_einheit").val(einheit);
            });
            $("#select_host").change(function (e) {
                var newHost = $(this).val();
                if (newHost == "custom") {
                    $('#customHostPortDiv').removeClass("hide");
                    $('#submitcustomhost').removeClass("hide");
                }
                else {
                    var h = newHost.substring(0, newHost.lastIndexOf(":"));
                    var p = newHost.substring(newHost.lastIndexOf(":") + 1);
                    SetHost(h, p);
                    $('#hostchangetext').removeClass('hide').delay(2000).fadeOut(1000);
                }
            });

            $('#submitcustomhost').click(function () {
                SetHost($('#customhost').val(), $('#customport').val());
                $('#hostchangetext').removeClass('hide').delay(2000).fadeOut(1000);
            });

            $('#btndonateme').click(function () {
                $('#myModalSendIOTA').modal("show");
                $('#address').val("BEDYKJPMSMKBHCMLZNSODECPNTO9TJNQHXTWVPJRBVDQDPDD9NDARDORDYOCYOZAGEQE9XTFIALNSIIPXWCBC9ESBX");
                $('#message').val("Donate from ");
            });
        }

        function SetHost(h, p) {
            iota = new IOTA({ 'host': h, 'port': p });
            localStorage.setItem('host', h);
            localStorage.setItem('port', p);
        }

        function updateBalanceHTML(balance) {
            document.getElementById('iota__balance').innerHTML = iota.utils.convertUnits(balance, 'i', einheit) + einheit;
            document.getElementById('iota__balance__header').innerHTML = iota.utils.convertUnits(balance, 'i', einheit) + einheit;
        }

        function updateAddressHTML(address) {
            if (!address)
                return
            var html = '<div class="panel panel-default"><div class="panel-heading">Address</div><div class="panel-body">' + address + '</div></div>'
            document.getElementById('allAddresses').innerHTML = html;
        }

        function SeedSubmit() {
            showPleaseWait('Get account...', 2000);
            getAccountInfo();
        }

        function getAccountInfo() {
            if (!IsSending) {
                return new Promise(function (resolve, reject) {
                    iota.api.getAccountData(seed, function (e, accountData) {
                        console.log("Account data", accountData);
                        if (!address && accountData.addresses[0]) {
                            address = iota.utils.addChecksum(accountData.addresses[accountData.addresses.length - 1]);
                            updateAddressHTML(address);
                            addresses = accountData.addresses;
                        }
                        BuildTransfer(accountData.transfers);
                        balance = accountData.balance;
                        updateBalanceHTML(balance);
                        hidePleaseWaitDiv();
                    })
                })
            }
            setInterval(getAccountInfo, 1000 * 60);

        }

        function BuildTransfer(transfers) {
            transactionen.innerHTML = '<div class="list-group">';

            for (var i = 0; i < transfers.length; i++) {
                var msg = "";
                var message = iota.utils.extractJson(transfers[i]);
                console.log("Extracted JSON from Transaction: ", message);
                if (message != null) {
                    message = JSON.parse(message);
                    console.log("JSON: ", message);
                    msg = message.message;
                }
                if (transfers[i].length > 1) {
                    var date = new Date(transfers[i][0].timestamp * 1000);
                    transactionen.innerHTML = '<li class="list-group-item">'
                        + '<span class="badge'
                        + (addresses.indexOf(transfers[i][0].address) > -1 ? ' bggreen' : ' bgred')
                        + '">' + transfers[i][0].value + '<span class="einheit">i</span></span>'
                        + '<div class="alert alert-default" role="alert">'
                        + (transfers[i][0].persistence == true ? '<span class="glyphicon glyphicon-ok" title="Status: Ok" aria-hidden="true"></span>' : '<span class="glyphicon glyphicon-time" title="Status: Pending" aria-hidden="true"></span>')
                        + '</div>'
                        + '<div class="list-group-item-text">'
                        + '<p class="msg">'
                        + msg
                        + '</p>'
                        + '<p class="tag label label-default">'
                        + transfers[i][0].tag
                        + '</p><br><br>'
                        + '<a href="http://www.iota.tips/search/?kind=transaction&hash=' + transfers[i][0].hash + '" target="_blank">'
                        + transfers[i][0].address
                        + '</a>'
                        + '</div>'
                        + '<p class="txdatetime">' + date.toLocaleString() + '</p>'
                        + '</li>'
                        + transactionen.innerHTML;
                }
                else {
                    var date = new Date(transfers[i][0].timestamp * 1000);
                    transactionen.innerHTML = '<li class="list-group-item">'
                        + '<div class="alert alert-default" role="alert">'
                        + '<span class="glyphicon glyphicon-bookmark" aria-hidden="true"></span>'
                        + '</div>'
                        + '<div class="list-group-item-text">'
                        + '<p class="msg">'
                        + msg
                        + '</p>'
                        + '<a href="http://www.iota.tips/search/?kind=transaction&hash=' + transfers[i][0].hash + '" target="_blank">'
                        + transfers[i][0].address
                        + '</a>'
                        + '</div>'
                        + '<p class="txdatetime">' + date.toLocaleString() + '</p>'
                        + '</li>'
                        + transactionen.innerHTML;
                }
            }
            transactionen.innerHTML += '</div>';
        }

        function genAddress() {
            console.log("Generating an address");
            document.getElementById("allAddresses").innerHTML = "Generating an address";
            iota.api.getNewAddress(seed, { 'checksum': true }, function (e, address) {
                if (!e) {
                    console.log("NEW ADDRESS GENERATED: ", address)
                    address = address;
                    updateAddressHTML(address)
                }
            })
        }

        function sendTransfer(address, value, messageTrytes) {
            IsSending = true;
            $('#send__waiting').show();
            var transfer = [{ 'address': address, 'value': parseInt(value), 'message': messageTrytes, 'tag': "ARDUIOTA9HARWARE9WALLET" }]
            console.log("Sending Transfer", transfer);
            return new Promise(function (resolve, reject) {
                //iota.api.sendTransfer(seed, 5, 9, transfer, (e, r) => { TESTNET
                iota.api.sendTransfer(seed, 5, 15, transfer, (e, r) => {
                    if (e !== null) {
                        console.log(e.message);
                        var html = '<div class="alert alert-danger alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><strong>ERROR!</strong>' + e + '.</div>'
                        document.getElementById('send__success').innerHTML = html;
                    } else {
                        console.log(r);
                        var html = '<div class="alert alert-info alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><strong>Success!</strong> You have successfully sent your transaction. If you want to make another one make sure that this transaction is confirmed first (check in your client).</div>'
                        document.getElementById('send__success').innerHTML = html;
                        balance = balance - value;
                        updateBalanceHTML(balance);
                        $('#send__waiting').hide();
                        IsSending = false;
                        getAccountInfo();
                    }
                    hidePleaseWaitDiv();
                })
            })
        }

        function GenAddress() {
            if (!seed)
                return;
            genAddress();
        }

        function Submit() {
            if (!seed) {
                var html = '<div class="alert alert-warning alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><strong>No Seed!</strong> You have not entered your seed yet. Do so on the Menu on the right.</div>'
                document.getElementById('send__success').innerHTML = html;
                return
            }
            if (!balance || balance === 0) {
                var html = '<div class="alert alert-warning alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><strong>No Tokens!</strong> You do not have enough IOTA tokens. Make sure you have enough confirmed tokens.</div>'
                document.getElementById('send__success').innerHTML = html;
                return
            }
            var wert = document.getElementById('value').value;
            wert = iota.utils.convertUnits(wert, einheit, 'i');
            var value = parseInt(wert);
            var address = document.getElementById('address').value;
            var message = document.getElementById('message').value;

            if (address == "") {
                var html = '<div class="alert alert-warning alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><strong>No addresse!</strong> You have no address to send.</div>'
                document.getElementById('send__success').innerHTML = html;
                return
            }
            if (!value) {
                var html = '<div class="alert alert-warning alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><strong>No Value!</strong> You have specified no value.</div>'
                document.getElementById('send__success').innerHTML = html;
                return
            }
            if (value > balance) {
                var html = '<div class="alert alert-warning alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><strong>Value too high!</strong> You have specified a too high value.</div>'
                document.getElementById('send__success').innerHTML = html;
                return
            }
            var messageToSend = { 'message': message }
            try {
                console.log("Sending Message: ", messageToSend);
                var messageTrytes = iota.utils.toTrytes(JSON.stringify(messageToSend));
                console.log("Converted Message into trytes: ", messageTrytes);
                document.getElementById('send__success').innerHTML = "";
                sendTransfer(address, value, messageTrytes);
            } catch (e) {
                console.log(e);
                var html = '<div class="alert alert-warning alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><strong>Wrong Format!</strong> Your message contains an illegal character. Make sure you only enter valid ASCII characters.</div>'
                document.getElementById('send__success').innerHTML = html;
            }
        }

        function refresh() {
            showPleaseWait('Refresh...', 100);
            getAccountInfo();
        }

        function showPleaseWait(txt, time) {
            setTimeout(function () {
                $("#txtModal").text(txt);
                $("#pleaseWaitDialog").fadeIn(1000).addClass("in");
                $('<div class="modal-backdrop"></div>').appendTo(document.body);
                $("#pleaseWaitDialog").show();
            }, time);

        }
        function hidePleaseWaitDiv() {
            $("#pleaseWaitDialog").removeClass("in");
            $(".modal-backdrop").remove();
            $("#pleaseWaitDialog").hide();
        }
        if (seed == "") {
            alert("Seed ist nicht gesetzt");
        }
        else {
            SeedSubmit();
        }
    </script>
</head>

<body>
    <main class="container-fluid">
        <header class="row">
            <img class="header__logo" src="https://mybcard.de/logo.png" /><span class="brand">IOTA</span>
            <div class="row">

                <div class="header-balance">
                    Balance: <span class="label label-default" id="iota__balance__header">0</span>
                </div>
                <div class="form-group">
                    <select class="form-control" id="select_einheit">
                      <option value="i">i</option>
                      <option value="Ki">Ki</option>
                      <option value="Mi">Mi</option>
                      <option value="Gi" selected>Gi</option>
                      <option value="Ti">Ti</option>
                      <option value="Pi">Pi</option>
                    </select>
                </div>
            </div>
        </header>
        <section class="send__section row">
            <div class="col-md-4" id="btnmenu">
                <button type="button" class="btn btn-default btn-block btn-lg glyphicon glyphicon-send" data-toggle="modal" data-target="#myModalSendIOTA"></button>
                <button type="button" class="btn btn-default btn-block btn-lg glyphicon glyphicon-list-alt" data-toggle="modal" data-target="#myModalGenerateAdress"></button>
                <button type="button" class="btn btn-default btn-block btn-lg glyphicon glyphicon-cog" data-toggle="modal" data-target="#myModalConfig"></button>
                <button type="button" class="btn btn-default btn-block btn-lg glyphicon glyphicon-refresh" onclick="refresh()"></button>
            </div>

            <div class="col-md-8">
                <div class="send__header">
                    <p class="send__header-title">Transactions</p>
                </div>
                <p id="transactionen"></p>


            </div>
        </section>
    </main>
    <div class="modal fade" id="myModalSendIOTA" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">
                        <img class="send__logo" src="https://mybcard.de/logo-black.png" /> Balance: <span class="label label-default"
                            id="iota__balance">0</span>
                    </h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="send__body">
                        <div class="row">
                            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                <label for="value">Value</label>
                                <div class="input-group">

                                    <input type="number" class="form-control" id="value" placeholder="Value to Send">
                                    <span class="input-group-addon">
                                        <select id="select_einheit_senden">
                                            <option value="i">i</option>
                                            <option value="Ki">Ki</option>
                                            <option value="Mi">Mi</option>
                                            <option value="Gi" selected>Gi</option>
                                            <option value="Ti">Ti</option>
                                            <option value="Pi">Pi</option>
                                        </select>
                                    </span>
                                </div>
                                <!-- /input-group -->
                            </div>
                            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                <div class="form-group">
                                    <label for="address">Recipient Address</label>
                                    <input type="text" class="form-control" id="address" placeholder="IOTA address of recipient">
                                </div>
                            </div>
                            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                <div class="form-group">
                                    <label for="message">Text Area</label>
                                    <textarea id="message" class="form-control" rows="3" placeholder="Message to send"></textarea>
                                </div>
                            </div>
                        </div>
                        <div id="send__success"></div>
                        <div id="send__waiting">
                            <div class="row">
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100"
                                        style="width:100%">
                                        <p>Doing Proof of Work. Please be patient!</p>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-success" role="alert">
                                <p>While waiting, you can read more about the <a href="https://dev.iota.org" class="alert-link">IOTA API here.</a>Or
                                    you can read our Blog on <a href="https://medium.com/iotatangle" class="alert-link">Medium</a>.
                                    Always useful to know this stuff.
                                    <p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="send__button">
                        <button class="btn btn-success btn-lg" id="submit" onclick="Submit()">Submit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="myModalGenerateAdress" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Generate Addresse</h4>
                </div>
                <div class="modal-body">
                    <div class="genAddress__div">
                        <div id="allAddresses">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="genAddress" class="btn btn-block btn-lg btn-success" onclick="GenAddress()">Generate Address</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="myModalConfig" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Nodes</h4>
                </div>
                <div class="modal-body">
                    <select class="form-control" id="select_host">
                        <option value="http://service.iotasupport.com:14265">http://service.iotasupport.com:14265</option>
                        <option value="http://eugene.iota.community:14265">http://eugene.iota.community:14265</option>
                        <option value="http://eugene.iotasupport.com:14999">http://eugene.iotasupport.com:14999</option>
                        <option value="http://eugeneoldisoft.iotasupport.com:14265">http://eugeneoldisoft.iotasupport.com:14265</option>
                        <option value="http://node01.iotatoken.nl:14265">http://node01.iotatoken.nl:14265</option>
                        <option value="http://node02.iotatoken.nl:14265">http://node02.iotatoken.nl:14265</option>
                        <option value="http://node03.iotatoken.nl:15265">http://node03.iotatoken.nl:15265</option>
                        <option value="http://node.deviceproof.org:1426">http://node.deviceproof.org:1426</option>
                        <option value="http://mainnet.necropaz.com:14500">http://mainnet.necropaz.com:14500</option>
                        <option value="http://5.9.149.169:14265">http://5.9.149.169:14265</option>
                        <option value="http://iota.digits.blue:14265">http://iota.digits.blue:14265</option>
                        <option value="http://wallets.iotamexico.com:80">http://wallets.iotamexico.com:80</option>
                        <option value="http://5.9.137.199:14265">http://5.9.137.199:14265</option>
                        <option value="http://5.9.118.112:14265">http://5.9.118.112:14265</option>
                        <option value="http://5.9.149.169:14265">http://5.9.149.169:14265</option>
                        <option value="http://88.198.230.98:14265">http://88.198.230.98:14265</option>
                        <option value="http://176.9.3.149:14265">http://176.9.3.149:14265</option>
                        <option value="https://n1.iota.nu:443" selected>https://n1.iota.nu:443</option>
                        <option value="http://node.lukaseder.de:14265">http://node.lukaseder.de:14265</option>
                        <option value="https://node.tangle.works:443">https://node.tangle.works:443</option>
                        <option value="custom">custom</option>
                      </select>
                    <div class="hide row" id="customHostPortDiv">
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                            <div class="form-group">
                                <label for="customhost">Custom Host</label>
                                <input type="text" class="form-control" id="customhost" placeholder="IOTA host adresse">
                            </div>
                        </div>
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                            <div class="form-group">
                                <label for="customport">Custom Port</label>
                                <input type="text" class="form-control" id="customport" placeholder="IOTA host port">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success btn-lg btn-block hide" id="submitcustomhost">Save</button>
                    <div class="alert alert-success hide" id="hostchangetext">
                        <strong>Success!</strong> changed...
                    </div>

                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="pleaseWaitDialog" data-backdrop="static" data-keyboard="false">
        <img class="image" src="https://mybcard.de/logo.png" alt="" width="120" height="120">
        <h1 id="txtModal" style="color: #fff;"></h1>
    </div>
    <div id="spende">
        Donate IOTA: <a href="#" id="btndonateme">BEDYKJPMSMKBHCMLZNSODECPNTO9TJNQHXTWVPJRBVDQDPDD9NDARDORDYOCYOZAGEQE9XTFIALNSIIPXWCBC9ESBX</a>
    </div>
</body>

</html>
